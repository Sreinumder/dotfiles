set ratios 1:2:3
set shell bash
set shellopts '-eu'
set ifs "\n"
set scrolloff 10
set cursorpreviewfmt "\033[7;2m"

set incsearch
set smartcase
set ignorecase
set anchorfind
set findlen 1
set tabstop 4
set info size
set preview
set dircounts

setlocal ~/Downloads sortby "atime"
setlocal ~/Downloads reverse

set cursorpreviewfmt "\033[7;2m"
set previewer '~/.config/lf/previewer'
set cleaner '~/.config/lf/cleaner'
set icons

# define a custom 'open' command
# This command is called when current file is not a directory. You may want to
# use either file extensions and/or mime types here. Below uses an editor for
# text files and a file opener for the rest.
cmd open &{{
    case $(file --mime-type "$(readlink -f $f)" -b) in
	application/vnd.openxmlformats-officedocument.spreadsheetml.sheet) localc $fx ;;
	image/vnd.djvu|application/pdf|application/octet-stream|application/postscript) setsid -f zathura $fx >/dev/null 2>&1 ;;
        text/*|application/json|inode/x-empty|application/x-subrip) $EDITOR $fx;;
	image/x-xcf) setsid -f gimp $f >/dev/null 2>&1 ;;
	image/svg+xml) display -- $f ;;
	image/*) rotdir $f | grep -i "\.\(png\|jpg\|jpeg\|gif\|webp\|avif\|tif\|ico\)\(_large\)*$" |
		setsid -f nsxiv -aio 2>/dev/null | while read -r file; do
			[ -z "$file" ] && continue
			lf -remote "send select \"$file\""
			lf -remote "send toggle"
		done &
		;;
	audio/*|video/x-ms-asf) mpv --audio-display=no $f ;;
	video/*) setsid -f mpv $f -quiet >/dev/null 2>&1 ;;
	application/pdf|application/vnd.djvu|application/epub*) setsid -f zathura $fx >/dev/null 2>&1 ;;
	application/pgp-encrypted) $EDITOR $fx ;;
	application/vnd.openxmlformats-officedocument.wordprocessingml.document|application/vnd.oasis.opendocument.text|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet|application/octet-stream|application/vnd.oasis.opendocument.spreadsheet|application/vnd.oasis.opendocument.spreadsheet-template|application/vnd.openxmlformats-officedocument.presentationml.presentation|application/vnd.oasis.opendocument.presentation-template|application/vnd.oasis.opendocument.presentation|application/vnd.ms-powerpoint|application/vnd.oasis.opendocument.graphics|application/vnd.oasis.opendocument.graphics-template|application/vnd.oasis.opendocument.formula|application/vnd.oasis.opendocument.database) setsid -f libreoffice $fx >/dev/null 2>&1 ;;
        *) for f in $fx; do setsid -f $OPENER $f >/dev/null 2>&1; done;;
    esac
}}


cmd mkdir $mkdir -p "$(echo $* | tr ' ' '\ ')"

# Create a directory with the selected items
cmd new-folder-with-selection ${{
  set -f
  printf "Directory name: "
  read newd
  mkdir -- "$newd"
  mv -- $fx "$newd"
}}

# og
# cmd delete ${{
#     echo "can do"
#     set -f
#     printf "$fs\n"
#     printf "delete?[y/n]"
#     read ans
#     [ "$ans" = "y" ] && rmtrash -rf $fs
# }}

# dont delte rise or home dir
# cmd delete ${{
#     case $1 in
#       "rise" | "home")
#         echo "cant delete"
#         ;;
#       *)
#         echo "can do"
#         set -f
#         printf "$fs\n"
#         printf "delete?[y/n]"
#         read ans
#         [ "$ans" = "y" ] && rmtrash -rf $fs
#     esac
# }}

cmd delete ${{
  if [[ $PWD == "/" || $PWD == "/home" ]]; then
    echo "cant in $PWD dir :("
    exit 1
  fi
  set -f
  echo "$fx"
  printf "delete?[y/n]"
  read ans
  [ "$ans" = "y" ] && rmtrash -rf $fx
}}

cmd extract ${{
    set -f
    case $f in
        *.tar.bz|*.tar.bz2|*.tbz|*.tbz2) tar xjvf $f;;
        *.tar.gz|*.tgz) tar xzvf $f;;
        *.tar.xz|*.txz) tar xJvf $f;;
        *.tar) tar xvf $f;;
        *.zip) unzip $f;;
        *.rar) unrar x $f;;
        *.7z) 7z x $f;;
        *) echo "Unsupported format";;
    esac
}}

# compress current file or selected files with tar and gunzip
cmd tar ${{
    set -f
    mkdir $1
    cp -r $fx $1
    tar czf $1.tar.gz $1
    rm -rf $1
}}

# compress current file or selected files with zip
cmd zip ${{
    set -f
    mkdir $1
    cp -r $fx $1
    zip -r $1.zip $1
    rm -rf $1
}} 

cmd select-all :unselect; invert

# Copy the file names (including extension) of the selections separated by \n
cmd copy-filename ${{
  names="$(echo $fx | tr ' ' '\n' | xargs -I{} basename {})"
  echo $names | tr ' ' '\n' | pbcopy }}

# Copy the absolute paths of selections separated by \n
cmd copy-absolute-path ${{
  echo $fx | tr ' ' '\n' | pbcopy
}}

# Select the file or directory via fzf
cmd fzf-select ${{
  IFS=' '
  exclude=$(cat $HOME/exclude | sed 's/^/--exclude /' | tr '\n' ' ')
  select=$(fd --hidden --follow $exclude | fzf) || true
  lf -remote "send $id select $select"
}}

# cd into the selected directory via fzf
cmd fzf-cd ${{
  IFS=' '
  exclude=$(cat $HOME/exclude | sed 's/^/--exclude /' | tr '\n' ' ')
  select=$(fd --type d --hidden --follow $exclude | fzf) || true
  lf -remote "send $id cd $select"
}}

# zoxide
cmd z %{{
  result="$(zoxide query --exclude $PWD $@ | sed 's/\\/\\\\/g;s/"/\\"/g')"
  lf -remote "send $id cd \"$result\""
}}

cmd zi ${{
  result="$(zoxide query -i | sed 's/\\/\\\\/g;s/"/\\"/g')"
  lf -remote "send $id cd \"$result\""
}}

map zo z
map zi zi
cmd nopreview &{{
	lf -remote "send $id set nopreview"
	lf -remote "send $id set ratios 1:3"
}}

cmd preview &{{
	lf -remote "send $id set preview"
	lf -remote "send $id set ratios 1:3"
}}

cmd default &{{
	lf -remote "send $id set preview"
	lf -remote "send $id set ratios 1:2:3"
}}
map ( preview
map * default
map ) nopreview

#unbind defaults
map e

map <enter> shell

map H jump-prev
map L jump-next
map J push 4j
map K push 4k

map <tab> :toggle;down
map yy copy
map yn copy-filename
map yP copy-absolute-path

map U !printf "\n";du -csh *
map <c-f> fzf-select
map <c-j> fzf-cd

# give a name and then make a directory
map ad push :mkdir<space>
map aa push <enter>touch<space>
map A new-folder-with-selection

map n push <enter>nvim<space>.<enter>

# all custom mappings
map D delete

map ee extract
map ec $$EDITOR "$f"
map el $$EDITOR ~/.config/lf/lfrc
map en $$EDITOR ~/.config/nvim
map ek $$EDITOR ~/.config/kitty
map <space>c push :zip<space>
map r
map rr rename # at the very end
map ra push A<c-a> # at the very beginning
map rn push A<c-u> # rename the filename
map re push A<c-f><c-k> # rename the extension

# [g]o [.]config/[?]__
map g.l cd ~/.config/lf
map g.a cd ~/.config/alacritty
map g.nn cd ~/.config/nvim
map g.np cd ~/.config/nvim/lua/risedev/plugins/
map g.nc cd ~/.config/nvim/lua/risedev/core/
map g.h cd ~/dotfiles/hypr
map g.D cd ~/dotfiles/dunst
map g.d cd ~/dotfiles

# [g]o [d]irectly to [?]__
map g.. cd ~/.config
map gdd cd ~/Downloads
map gdp cd ~/Pictures
map gds cd ~/Desktop
map gdn cd ~/notes
map gdm cd ~/Music
map gdo cd ~/Documents
map gdr cd ~/rose
map gdw cd ~/wallpaper

# [g]o [?]__/[?]__
map grl cd ~/rose/learn
map grpl cd ~/rose/py/class
map grpl cd ~/rose/py/lab
map grpp cd ~/rose/py/project

map grn cd ~/rose/norg
map grd cd ~/rose/dotReferences
map grt cd ~/rose/tools

#bunch of stuff idk
# map x $$f
# map X !$f

cmap <tab> cmd-menu-complete
cmap <backtab> cmd-menu-complete-back

# dedicated keys for file opener actions
map o &mimeopen $f
map O $mimeopen --ask $f
